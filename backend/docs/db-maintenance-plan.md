# 数据库维护计划

本文档概述了TasksHub系统数据库的维护计划和最佳实践。

## 维护时间表

| 维护任务 | 频率 | 负责人 | 工具 |
|---------|------|-------|------|
| 数据备份 | 每日 | 数据库管理员 | `backup-db.sh` |
| 数据库状态监控 | 每日 | 系统管理员 | `monitor-db.sh` |
| 性能优化与调整 | 每周 | 数据库管理员 | MySQL工具集 |
| 索引优化 | 每月 | 数据库管理员 | SQL查询 |
| 数据清理 | 每季度 | 数据库管理员 | SQL脚本 |
| 安全审计 | 每季度 | 安全团队 | 安全审计工具 |

## 备份策略

1. **完整备份**：每日凌晨2:00执行完整备份
2. **增量备份**：每4小时执行一次增量备份
3. **备份保留**：完整备份保留30天，增量备份保留7天
4. **备份验证**：每周进行一次备份恢复测试，确保备份可用性
5. **备份存储**：备份文件存储在本地和远程存储，确保数据安全

## 监控指标

以下是需要定期监控的关键数据库指标：

1. **连接数**：监控活动连接数和最大连接数
2. **查询性能**：监控慢查询日志，分析耗时查询
3. **表大小**：监控表数据增长情况，及时进行分区或归档
4. **磁盘空间**：监控数据和日志文件的磁盘使用率
5. **锁等待**：监控锁等待事件，排查潜在的并发问题
6. **InnoDB缓冲池**：监控缓冲池命中率和使用情况

## 优化建议

### 查询优化

1. 避免使用`SELECT *`，只选择需要的字段
2. 确保查询条件字段已创建适当的索引
3. 使用EXPLAIN分析查询执行计划
4. 避免在查询条件中使用函数，可能导致索引失效
5. 对于大结果集使用分页查询

### 索引优化

1. 定期检查未使用的索引并考虑删除
2. 确保外键字段有索引
3. 对经常作为查询条件的字段创建索引
4. 避免过多索引，可能影响写入性能
5. 使用复合索引优化多条件查询

### 表设计优化

1. 使用适当的字段类型和长度
2. 对大表考虑分区策略
3. 定期执行OPTIMIZE TABLE优化表结构
4. 对于历史数据考虑归档策略
5. 使用InnoDB存储引擎，支持事务和行级锁

## 紧急恢复流程

1. **识别问题**：确认数据库故障类型和范围
2. **通知相关方**：通知技术团队和业务方
3. **停止服务**：如需要，暂时停止应用服务器
4. **备份当前状态**：如可能，对当前数据进行备份
5. **执行恢复**：使用`restore-db.sh`脚本从最近的备份恢复
6. **验证数据**：恢复后验证数据完整性
7. **重启服务**：验证无误后重启应用服务
8. **事后分析**：分析故障原因并制定预防措施

## 工具使用说明

### 备份工具

```bash
# 执行备份
cd backend/scripts
./backup-db.sh

# 查看备份列表
ls -la ../backups/
```

### 恢复工具

```bash
# 恢复最新备份
cd backend/scripts
./restore-db.sh

# 恢复指定备份
./restore-db.sh taskshub_dev_backup_20240406120000.sql.gz
```

### 监控工具

```bash
# 执行监控
cd backend/scripts
./monitor-db.sh

# 查看监控日志
cat ../logs/db_monitor_20240406.log
```

## 最佳实践

1. 遵循最小权限原则配置数据库用户权限
2. 定期更新数据库密码和安全配置
3. 保持数据库软件版本更新，修复已知安全漏洞
4. 使用参数化查询，避免SQL注入风险
5. 配置合理的连接池大小，避免连接泄漏
6. 实施数据库活动日志审计
7. 为长时间运行的事务设置超时机制
8. 为敏感数据实施加密存储 